#cloud-config
#
# Prometheus + Grafana (nur node0)
# Idempotent: Downloads nur wenn nicht vorhanden
#

write_files:
  # prometheus.yml
  - path: /opt/prometheus/prometheus.yml
    content: |
      global:
        scrape_interval: 15s
        evaluation_interval: 15s
      
      scrape_configs:
        - job_name: 'prometheus'
          static_configs:
            - targets: ['localhost:9090']
      
        - job_name: 'node'
          static_configs:
            - targets:
                - 'node0.cloud.local:9100'
                - 'node1.cloud.local:9100'
                - 'node2.cloud.local:9100'
                - 'node3.cloud.local:9100'
                - 'node4.cloud.local:9100'
      
        - job_name: 'solr'
          static_configs:
            - targets:
                - 'node1.cloud.local:9404'
                - 'node2.cloud.local:9404'
                - 'node3.cloud.local:9404'
                - 'node4.cloud.local:9404'
      
        - job_name: 'spark'
          static_configs:
            - targets:
                - 'node1.cloud.local:9405'
                - 'node2.cloud.local:9405'
                - 'node3.cloud.local:9405'
                - 'node4.cloud.local:9405'
      
        - job_name: 'zookeeper'
          static_configs:
            - targets:
                - 'node1.cloud.local:9406'
                - 'node2.cloud.local:9406'
                - 'node3.cloud.local:9406'

  # Prometheus Service
  - path: /etc/systemd/system/prometheus.service
    content: |
      [Unit]
      Description=Prometheus
      After=network.target
      
      [Service]
      Type=simple
      User=cloudadmin
      ExecStart=/opt/prometheus/prometheus \
          --config.file=/opt/prometheus/prometheus.yml \
          --storage.tsdb.path=/data/prometheus \
          --storage.tsdb.retention.time=30d \
          --web.listen-address=:9090
      Restart=on-failure
      RestartSec=10
      
      [Install]
      WantedBy=multi-user.target

  # Grafana APT Repository
  - path: /etc/apt/sources.list.d/grafana.list
    content: |
      deb https://packages.grafana.com/oss/deb stable main

runcmd:
  # Verzeichnisse erstellen (idempotent)
  - mkdir -p /opt/prometheus /data/prometheus
  - chown -R cloudadmin:cloudadmin /opt/prometheus /data/prometheus
  
  # Prometheus installieren (nur wenn nicht vorhanden)
  - |
    if [ ! -f /opt/prometheus/prometheus ]; then
      PROM_VERSION="2.50.1"
      cd /tmp
      wget -q "https://github.com/prometheus/prometheus/releases/download/v${PROM_VERSION}/prometheus-${PROM_VERSION}.linux-amd64.tar.gz"
      tar -xzf prometheus-${PROM_VERSION}.linux-amd64.tar.gz
      cp -r prometheus-${PROM_VERSION}.linux-amd64/* /opt/prometheus/
      chown -R cloudadmin:cloudadmin /opt/prometheus
      rm -rf prometheus-${PROM_VERSION}.linux-amd64*
    fi
  
  # Grafana installieren (nur wenn nicht vorhanden)
  - |
    if ! dpkg -l grafana 2>/dev/null | grep -q "^ii"; then
      apt-get install -y apt-transport-https software-properties-common
      wget -q -O - https://packages.grafana.com/gpg.key | apt-key add -
      apt-get update
      apt-get install -y grafana
    fi
  
  # Services aktivieren (idempotent)
  - systemctl daemon-reload
  - systemctl enable prometheus grafana-server
  - systemctl restart prometheus grafana-server
