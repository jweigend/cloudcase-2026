#cloud-config
#
# Prometheus + Grafana + Node Exporter (node0)
#

write_files:
  # prometheus.yml
  - path: /opt/prometheus/prometheus.yml
    content: |
      global:
        scrape_interval: 15s
        evaluation_interval: 15s
      
      scrape_configs:
        - job_name: 'prometheus'
          static_configs:
            - targets: ['localhost:9090']
      
        - job_name: 'node'
          static_configs:
            - targets:
                - 'node0.cloud.local:9100'
                - 'node1.cloud.local:9100'
                - 'node2.cloud.local:9100'
                - 'node3.cloud.local:9100'
                - 'node4.cloud.local:9100'
      
        - job_name: 'solr'
          static_configs:
            - targets:
                - 'node1.cloud.local:9404'
                - 'node2.cloud.local:9404'
                - 'node3.cloud.local:9404'
                - 'node4.cloud.local:9404'
      
        - job_name: 'spark'
          static_configs:
            - targets:
                - 'node1.cloud.local:9405'
                - 'node2.cloud.local:9405'
                - 'node3.cloud.local:9405'
                - 'node4.cloud.local:9405'
      
        - job_name: 'zookeeper'
          static_configs:
            - targets:
                - 'node1.cloud.local:9406'
                - 'node2.cloud.local:9406'
                - 'node3.cloud.local:9406'

  # Prometheus Service
  - path: /etc/systemd/system/prometheus.service
    content: |
      [Unit]
      Description=Prometheus
      After=network.target
      
      [Service]
      Type=simple
      User=cloudadmin
      ExecStart=/opt/prometheus/prometheus \
          --config.file=/opt/prometheus/prometheus.yml \
          --storage.tsdb.path=/data/prometheus \
          --storage.tsdb.retention.time=30d \
          --web.listen-address=:9090
      Restart=on-failure
      RestartSec=10
      
      [Install]
      WantedBy=multi-user.target

  # Node Exporter Service
  - path: /etc/systemd/system/node_exporter.service
    content: |
      [Unit]
      Description=Node Exporter
      After=network.target
      
      [Service]
      Type=simple
      User=cloudadmin
      ExecStart=/usr/local/bin/node_exporter
      Restart=on-failure
      
      [Install]
      WantedBy=multi-user.target

runcmd:
  # Prometheus installieren
  - |
    PROM_VERSION="2.50.1"
    if [ ! -d /opt/prometheus ]; then
      cd /tmp
      wget -q "https://github.com/prometheus/prometheus/releases/download/v${PROM_VERSION}/prometheus-${PROM_VERSION}.linux-amd64.tar.gz"
      tar -xzf prometheus-${PROM_VERSION}.linux-amd64.tar.gz
      mv prometheus-${PROM_VERSION}.linux-amd64 /opt/prometheus
      chown -R cloudadmin:cloudadmin /opt/prometheus
      rm prometheus-${PROM_VERSION}.linux-amd64.tar.gz
    fi
  
  # Node Exporter installieren
  - |
    NE_VERSION="1.7.0"
    if [ ! -f /usr/local/bin/node_exporter ]; then
      cd /tmp
      wget -q "https://github.com/prometheus/node_exporter/releases/download/v${NE_VERSION}/node_exporter-${NE_VERSION}.linux-amd64.tar.gz"
      tar -xzf node_exporter-${NE_VERSION}.linux-amd64.tar.gz
      mv node_exporter-${NE_VERSION}.linux-amd64/node_exporter /usr/local/bin/
      rm -rf node_exporter-${NE_VERSION}.linux-amd64*
    fi
  
  # Grafana installieren
  - apt-get install -y apt-transport-https software-properties-common
  - wget -q -O - https://packages.grafana.com/gpg.key | apt-key add -
  - echo "deb https://packages.grafana.com/oss/deb stable main" > /etc/apt/sources.list.d/grafana.list
  - apt-get update
  - apt-get install -y grafana
  
  - chown -R cloudadmin:cloudadmin /data/prometheus
  - systemctl daemon-reload
  - systemctl enable prometheus node_exporter grafana-server
