#cloud-config
#
# ZooKeeper Installation (node1-3)
# Idempotent: Download nur wenn nicht vorhanden
#

write_files:
  # zoo.cfg
  - path: /opt/zookeeper/conf/zoo.cfg
    content: |
      tickTime=2000
      initLimit=10
      syncLimit=5
      dataDir=/data/zookeeper
      clientPort=2181
      
      server.1=node1.cloud.local:2888:3888
      server.2=node2.cloud.local:2888:3888
      server.3=node3.cloud.local:2888:3888
      
      autopurge.snapRetainCount=3
      autopurge.purgeInterval=24
      
      4lw.commands.whitelist=ruok,stat,mntr

  # JVM Einstellungen
  - path: /opt/zookeeper/conf/java.env
    content: |
      export JVMFLAGS="-Xms1g -Xmx1g"

  # Systemd Service
  - path: /etc/systemd/system/zookeeper.service
    content: |
      [Unit]
      Description=Apache ZooKeeper
      After=network.target
      
      [Service]
      Type=forking
      User=cloudadmin
      Environment="JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
      Environment="ZOO_LOG_DIR=/data/zookeeper"
      ExecStart=/opt/zookeeper/bin/zkServer.sh start
      ExecStop=/opt/zookeeper/bin/zkServer.sh stop
      Restart=on-failure
      RestartSec=10
      
      [Install]
      WantedBy=multi-user.target

runcmd:
  # Verzeichnisse erstellen (idempotent)
  - mkdir -p /opt/zookeeper/conf /data/zookeeper
  - chown -R cloudadmin:cloudadmin /data/zookeeper
  
  # ZooKeeper installieren (nur wenn nicht vorhanden)
  - |
    if [ ! -f /opt/zookeeper/bin/zkServer.sh ]; then
      ZK_VERSION="3.9.2"
      cd /tmp
      wget -q "https://downloads.apache.org/zookeeper/zookeeper-${ZK_VERSION}/apache-zookeeper-${ZK_VERSION}-bin.tar.gz"
      tar -xzf apache-zookeeper-${ZK_VERSION}-bin.tar.gz
      cp -r apache-zookeeper-${ZK_VERSION}-bin/* /opt/zookeeper/
      chown -R cloudadmin:cloudadmin /opt/zookeeper
      rm -rf apache-zookeeper-${ZK_VERSION}-bin*
    fi
  
  # myid setzen basierend auf Hostname (idempotent)
  - |
    HOSTNAME=$(hostname)
    case $HOSTNAME in
      node1) echo "1" > /data/zookeeper/myid ;;
      node2) echo "2" > /data/zookeeper/myid ;;
      node3) echo "3" > /data/zookeeper/myid ;;
    esac
    chown cloudadmin:cloudadmin /data/zookeeper/myid
  
  # Service aktivieren (idempotent)
  - systemctl daemon-reload
  - systemctl enable zookeeper
