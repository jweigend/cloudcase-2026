#cloud-config
#
# Solr Cloud Installation (alle Nodes)
#

write_files:
  # solr.in.sh
  - path: /opt/solr/bin/solr.in.sh
    content: |
      SOLR_HEAP="8g"
      SOLR_HOME="/data/solr"
      SOLR_JAVA_HOME="/usr/lib/jvm/java-17-openjdk-amd64"
      ZK_HOST="node1.cloud.local:2181,node2.cloud.local:2181,node3.cloud.local:2181"
      
      # JMX f√ºr Monitoring
      ENABLE_REMOTE_JMX_OPTS="true"
      RMI_PORT="9404"
      
      # GC
      GC_TUNE="-XX:+UseG1GC -XX:MaxGCPauseMillis=200"

  # Systemd Service
  - path: /etc/systemd/system/solr.service
    content: |
      [Unit]
      Description=Apache Solr Cloud
      After=network.target zookeeper.service
      Wants=zookeeper.service
      
      [Service]
      Type=forking
      User=cloudadmin
      Environment="SOLR_INCLUDE=/opt/solr/bin/solr.in.sh"
      ExecStart=/opt/solr/bin/solr start -c
      ExecStop=/opt/solr/bin/solr stop
      Restart=on-failure
      RestartSec=10
      MemoryMax=10G
      CPUQuota=200%
      
      [Install]
      WantedBy=multi-user.target

runcmd:
  # Solr herunterladen und installieren
  - |
    SOLR_VERSION="9.5.0"
    if [ ! -d /opt/solr ]; then
      cd /tmp
      wget -q "https://downloads.apache.org/solr/solr/${SOLR_VERSION}/solr-${SOLR_VERSION}.tgz"
      tar -xzf solr-${SOLR_VERSION}.tgz
      mv solr-${SOLR_VERSION} /opt/solr
      chown -R cloudadmin:cloudadmin /opt/solr
      rm solr-${SOLR_VERSION}.tgz
    fi
  
  - chown -R cloudadmin:cloudadmin /data/solr
  - systemctl daemon-reload
  - systemctl enable solr
