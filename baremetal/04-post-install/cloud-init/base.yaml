#cloud-config
#
# Basis-Konfiguration für alle Nodes
# Idempotent: Pakete werden nur installiert wenn fehlen
#

packages:
  - openjdk-17-jdk
  - curl
  - wget
  - netcat-openbsd
  - htop
  - vim
  - tmux

write_files:
  # Kernel-Parameter für Big Data
  - path: /etc/sysctl.d/99-cloudkoffer.conf
    content: |
      # Netzwerk
      net.core.somaxconn = 65535
      net.ipv4.tcp_max_syn_backlog = 65535
      
      # Speicher
      vm.swappiness = 1
      vm.max_map_count = 262144
      
      # Datei-Deskriptoren
      fs.file-max = 2097152
    
  # Limits für cloudadmin
  - path: /etc/security/limits.d/99-cloudkoffer.conf
    content: |
      cloudadmin soft nofile 65535
      cloudadmin hard nofile 65535
      cloudadmin soft nproc 65535
      cloudadmin hard nproc 65535

runcmd:
  # Firewall deaktivieren (idempotent)
  - ufw disable || true
  # Swap deaktivieren (idempotent)
  - swapoff -a || true
  # Swap aus fstab entfernen (idempotent mit grep-check)
  - grep -q swap /etc/fstab && sed -i '/swap/d' /etc/fstab || true
  # Sysctl neu laden
  - sysctl --system || true
