#cloud-config
#
# DNS Server Konfiguration (nur node0)
# Idempotent: Alles in write_files, runcmd nur systemctl
#

packages:
  - dnsmasq

write_files:
  # Komplette dnsmasq Konfiguration
  - path: /etc/dnsmasq.d/cloud-local.conf
    content: |
      # Cloudkoffer DNS Forwarding
      domain=cloud.local
      local=/cloud.local/
      expand-hosts
      
      # Upstream DNS
      server=8.8.8.8
      server=8.8.4.4
      
      # Listen on all interfaces
      listen-address=0.0.0.0
      bind-interfaces
      
      # Zusätzliche Hosts-Datei
      addn-hosts=/etc/hosts.cloud

  # Hosts file für cloud.local Domain
  - path: /etc/hosts.cloud
    content: |
      192.168.1.100 node0 node0.cloud.local
      192.168.1.101 node1 node1.cloud.local
      192.168.1.102 node2 node2.cloud.local
      192.168.1.103 node3 node3.cloud.local
      192.168.1.104 node4 node4.cloud.local

  # resolv.conf (node0 nutzt sich selbst als DNS)
  - path: /etc/resolv.conf
    content: |
      nameserver 127.0.0.1
      search cloud.local

runcmd:
  # systemd-resolved deaktivieren (idempotent)
  - systemctl disable systemd-resolved || true
  - systemctl stop systemd-resolved || true
  # dnsmasq aktivieren und starten (idempotent)
  - systemctl daemon-reload
  - systemctl enable dnsmasq
  - systemctl restart dnsmasq
